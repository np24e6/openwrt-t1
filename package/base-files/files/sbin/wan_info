#!/bin/sh
. /lib/functions/network.sh

tempinterf=$(uci -q get mwan3.globals.mode)

if [ "$tempinterf" == "balance" ]; then
	interface="balance_default:"
elif [ "$tempinterf" == "mwan" ]; then
	interface="mwan_default:"
fi

mwanpolicies="$(/usr/sbin/mwan3 policies 2>&1 | grep % | awk '!seen[$1]++ {print $1}')"

for value in $mwanpolicies; do
	wanintr="$value $wanintr"
done

if { [ -z "$wanintr" ] || [ "$wanintr" == "unreachable" ] ;}; then
	if [ -z "$wanif" ] && ! network_find_wan wanif "" 10; then
	echo "$cfg" "NO_WAN_LINK"
	exit
	fi
else
	wanif="$wanintr"
fi

min_wanif=$(echo "$wanif" | awk '{print $1;}')
network_get_metric min_metric "$min_wanif"
for i in $wanif
do
        network_get_metric metric "$i"
        if [ $metric -lt $min_metric ]; then
                min_metric=$metric
                min_wanif=$i
        fi
done
wanif=$min_wanif

case "$1" in
	"ip")
		network_get_ipaddrs wanadr "$wanif"
		[ -z "$wanadr" ] && network_get_ipaddrs wanadr "$wanif"_4
		[ -z "$wanadr" ] && network_get_ipaddrs wanadr "$wanif"_6
		echo "$wanadr"
		;;
	"state")
		network_get_device wandev "$wanif"
		case "$wandev" in
			"wwan"* | "rmnet"* | "qmimux"* | "usb"*)
				echo "Mobile"
				;;
			"eth"* | "wan"*)
				echo "Wired"
				;;
			"wlan0")
				echo "WiFi"
				;;
		esac
		;;
	"interface")
		network_get_device wandev "$wanif"
		echo "$wandev"
		;;
esac
